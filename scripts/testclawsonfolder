#!/bin/bash

SCRIPT_NAME="${0}"
PROCESS_DIR="${1}"
LOG_DIR=/home/jsae/Admin/log
LOGFILE=agent-claws.log
LOG_DIR_EXISTS=0
WATCH_LOG="${2}"

if [ $# -eq 0 ];then
  printf '\n%s:\n\t%s %s\n' 'Usage' ${SCRIPT_NAME} '<Directory> <Option>'
  printf '\n%s\n' 'Runs Agent Claws on files in <Directory> and logs error code'
  printf '\n%s:\n\t%s\t%s\t%s\n' 'Option' 'w' 'open URXVT terminal and watch the log'
  exit 0
fi

if [ ! -d ${LOG_DIR} ]; then
  read -p "Where do you want your log? (full path, without ~) " LOG_DIR
  if [ -d ${LOG_DIR} ]; then
    LOG_DIR_EXISTS=1
  else
    printf '%s %s\n' 'Creating' ${LOG_DIR}
    echo "mkdir -v ${LOG_DIR}"
    mkdir -v "${LOG_DIR}"
    printf '%s\n' 'Done'
  fi
fi
if [ "${WATCH_LOG}" = "w" ]; then
  WATCHLOG=1
  urxvt -e fish -C "clear;tail -f ${LOG_DIR}/${LOGFILE}"&
else
  WATCHLOG=0
fi
if [ -d ${LOG_DIR} ]; then
  echo "Logs saved as ${LOG_DIR}/${LOGFILE}"
  echo "$(date "+%Y-%m-%d %T") : ----- New Run ----- ----- -----"  >> ${LOG_DIR}/${LOGFILE} 2>&1
  echo "Running: agent --channel=txt --meta=off --watch=\"http\" --flag-error claws \"<file>\""
  if [ -d ${PROCESS_DIR} ]; then
    echo "Working on ${PROCESS_DIR}"
    for f in ${PROCESS_DIR}/*; do
      if [ -f "${f}" ]; then
        echo ${f}
        agent --channel=txt --meta=off --watch="http" --flag-error claws "${f}" 
        STATUS="$?"
        echo "$(date "+%Y-%m-%d %T") : agent claws - ${f}, status ${STATUS}"  >> ${LOG_DIR}/${LOGFILE} 2>&1
        echo ${STATUS}
      else
       printf '%s %s\n' ${f} 'not file'
      fi
    done
  fi
fi
